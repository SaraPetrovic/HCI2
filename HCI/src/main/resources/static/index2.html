<!DOCTYPE html>
<html lang="en">
<head>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet"> 
<link href="https://cdn.datatables.net/1.10.16/css/dataTables.bootstrap.min.css" rel="stylesheet">
  <title>Bootstrap Example</title>
  <meta charset="utf-8">
  <link rel='stylesheet' href='calendar-lib/fullcalendar.css' />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src='moment-lib/moment.min.js'></script>
  <script src='calendar-lib/fullcalendar.js'></script>

  <script>
function ucitajKartice() {

      // initialize the external events
      // -----------------------------------------------------------------
	  
      $('#external-events .fc-event').each(function() {

        // store data so the calendar knows to render an event upon drop
        $(this).data('event', {
          title: $.trim($(this).text()),
		  duration : $(this).attr("duration"),// use the element's text as the event title
          stick: true // maintain when user navigates (see docs on the renderEvent method)
        });

        // make the event draggable using jQuery UI
        $(this).draggable({
          zIndex: 999,
		  containment: ".fc-agenda-body table",

          revert: true,      // will cause the event to go back to its
          revertDuration: 0  //  original position after the drag
        });

      });   
};
    
$( document ).ready(function() {
	

	
});
$.ajax({
    contentType: 'application/json',
    dataType: 'json',
    success: function(ucionice){
				var i = 0;
			  ucionice.forEach(function(ucionica) {
			  		var liClass = '';
			  		var tab = '';
			  		var tabContent = '';
					if (i == 0){
						liClass = 'class="active"';
					}
					var tab = '<li '+ liClass + '><a data-toggle="tab" href="#tab_' + ucionica.oznaka +'">' +ucionica.oznaka +'</a></li>';
					$("#tabs").append(tab);
					var tabContent = '<div id="tab_' + ucionica.oznaka +'" class="tab-pane fade in active"><div class="calendar-container"><div class="calendarCss" id="calendar_' + ucionica.oznaka +'"></div></div></div>';
					$("#tabsContent").append(tabContent);
					i++;
				
					
					$("#calendar_" + ucionica.oznaka).css("max-width", "900px;");
					$("#calendar_" + ucionica.oznaka).css("margin", "20px auto;");
					initTable(ucionica.oznaka);
					liClass = '';
					
				});
			  
			  
    },
    processData: false,
    type: 'GET',
    url: '/api/ucionice'
});
var predmetiUcitani = 0;
$.ajax({
    contentType: 'application/json',
    dataType: 'json',
    success: function(predmeti){
				
			  predmeti.forEach(function(predmet) {
				    var hours = Math.floor( (predmet.duzinaTermina * 45) / 60);          
				    var minutes = (predmet.duzinaTermina*45) % 60;
					var kartica = '<div class="fc-event" duration="' +hours + ':' + minutes +'">' + predmet.oznaka + '</div>';
					$("#predmeti").append(kartica);			
				});
			  ucitajKartice();
	
    },
    processData: false,
    type: 'GET',
    url: '/api/predmeti'
});

function initTable(id){
	      $('#calendar_' + id).fullCalendar({
        
        hiddenDays: [ 0 ],
        defaultView: 'agendaWeek',
        allDaySlot: false,
        slotEventOverlap: false,
        slotDuration: '00:15:00',
        slotLabelInterval: '01:45',
        minTime: '07:00:00',
        maxTime: '22:00:00',
        eventOverlap: false,
        defaultTimedEventDuration: '00:45:00',
        eventDurationEditable : false,
        editable: true,
        droppable: true, // this allows things to be dropped onto the calendar
        eventResize: function(event, delta, revertFunc) {

          var duration = moment.duration(event.end - event.start);
          var limit = moment.duration(45, 'minutes');
          if ( duration < limit) {
            alert("Class minimum duration is 45min!!!! Resize canceled!");
            revertFunc();
          }

        },
		
			
        drop: function(date, jsEvent, ui, resourceId) {
          // is the "remove after drop" checkbox checked?
		  console.log($(this).start)
		  
		  console.log(ui.start)
          if ($('#drop-remove').is(':checked')) {
            // if so, remove the element from the "Draggable Events" list

            alert("Dropped on " + date.format());
            $(this).remove();
          }
        },
		eventDrop: function(event, delta, revertFunc) {
            //inner column movement drop so get start and call the ajax function......
			//alert(moment("07:00", "HH:mm"));
			var momentStart = moment(event.start);
			var momentEnd = moment(event.end);
			var duration = moment.duration(event.end - event.start);
			if (momentStart.hours() < moment("07:00:00", "HH:mm:ss").hours()){
				//event.start = moment("07:00", "HH:mm").format();
				
				momentStart.hours(7).valueOf();
				momentStart.minutes(0).valueOf();
				momentEnd.hours(7 + duration.hours()).valueOf();
				momentEnd.minutes(0 + duration.minutes()).valueOf();
				event.end = momentEnd.format();
				event.start = momentStart.format();
				
			}
            $('#calendar_' + id).fullCalendar('updateEvent', event);

        },
      });
	      $(".fc-header-toolbar").empty();
	  	
	  	$(".fc-mon").children().html("<span>PONEDELJAK<span>");
	  	$(".fc-tue").children().html("<span>UTORAK<span>");
	  	$(".fc-wed").children().html("<span>SREDA<span>");
	  	$(".fc-thu").children().html("<span>ÄŒETVRTAK<span>");
	  	$(".fc-fri").children().html("<span>PETAK<span>");
	  	$(".fc-sat").children().html("<span>SUBOTA<span>");
}
  </script>
  <style>
    html, body {
    margin: 0;
    padding: 0;
    font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
    font-size: 14px;
  }

    #external-events {
      position: fixed;
      z-index: 2;
      top: 20px;
      left: 20px;
      width: 150px;
      padding: 0 10px;
      border: 1px solid #ccc;
      background: #eee;
    }

    #external-events .fc-event {
      margin: 1em 0;
      cursor: move;
    }

    #calendar-container {
      position: relative;
      z-index: 1;
      margin-left: 200px;
    }

    .calendarCss {
      max-width: 900px;
      margin: 20px auto;
    }
	#calendar1 {
      max-width: 900px;
      margin: 20px auto;
    }
	#calendar2 {
      max-width: 900px;
      margin: 20px auto;
    }
	#calendar3 {
      max-width: 900px;
      margin: 20px auto;
    }
  </style>
</head>

<body>

  
  <div id='external-events'>
    <p>
      <strong>Predmeti</strong>
    </p>
    	<div id="predmeti">

    	</div>
    <p>
      <input type='checkbox' id='drop-remove' />
      <label for='drop-remove'>remove after drop</label>
    </p>
  </div>
    <h2 style="margin-left:20%;">RASPORED</h2>
  <ul class="nav nav-tabs" id="tabs" style="margin-bottom:20px;margin-left:20%;">
    

  </ul>
   <div class="tab-content" id="tabsContent">
 		

	</div>
</body>


<script>

</script>

</html>